<!DOCTYPE html>
<html lang="ru" id="html">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–†—ã–±–æ–ª–æ–≤–Ω—ã–π –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root {
      --bg: #ffffff;
      --text: #222222;
      --card-bg: #f9f9f9;
      --header-bg: #1a5f23;
      --button-bg: #4CAF50;
      --button-hover: #388E3C;
    }

    [data-theme="dark"] {
      --bg: #121212;
      --text: #e0e0e0;
      --card-bg: #1e1e1e;
      --header-bg: #0d3b1a;
      --button-bg: #388E3C;
      --button-hover: #2E7D32;
    }

    body {
      background-color: var(--bg);
      color: var(--text);
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      transition: background-color 0.3s, color 0.3s;
    }

    header {
      background: var(--header-bg);
      color: white;
      padding: 1rem;
      text-align: center;
    }

    .controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
      flex-wrap: wrap;
    }

    #cityInput {
      padding: 6px 10px;
      border-radius: 4px;
      border: 1px solid #ccc;
      width: 180px;
    }

    nav button {
      margin: 0.3rem;
      padding: 0.5rem 1rem;
      background: var(--button-bg);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    nav button:hover {
      background: var(--button-hover);
    }

    #content {
      padding: 1rem;
    }

    .fish-card, .tip-card, .forecast-day {
      background: var(--card-bg);
      margin: 1rem 0;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: background 0.3s;
    }

    /* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–µ–º—ã */
    .theme-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }

    .theme-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }

    input:checked + .slider {
      background-color: #4CAF50;
    }

    input:checked + .slider:before {
      transform: translateX(26px);
    }

    #map {
      height: 70vh;
      width: 100%;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .leaflet-popup-content {
      font-size: 14px;
    }
  </style>
</head>
<body>
  <header>
    <h1>üé£ –†—ã–±–æ–ª–æ–≤–Ω—ã–π –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫</h1>
    <div class="controls">
      <input type="text" id="cityInput" placeholder="–ì–æ—Ä–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ú–æ—Å–∫–≤–∞)" />
      <button onclick="loadForecast()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</button>
      <label class="theme-switch">
        <input type="checkbox" id="themeToggle">
        <span class="slider"></span>
      </label>
    </div>
    <nav>
      <button onclick="showSection('fish')">–†—ã–±—ã –†–§</button>
      <button onclick="showSection('forecast')">–ü—Ä–æ–≥–Ω–æ–∑ –∫–ª—ë–≤–∞</button>
      <button onclick="showSection('map')">–ö–∞—Ä—Ç–∞ –≤–æ–¥–æ—ë–º–æ–≤</button>
      <button onclick="showSection('tips')">–°–æ–≤–µ—Ç—ã</button>
    </nav>
  </header>

  <main id="content">
    <p>–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª –≤—ã—à–µ.</p>
  </main>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // === –ù–ê–°–¢–†–û–ô–ö–ò ===
    const API_KEY = 'aa21616f5e84be6f7db6b7d19ebab51b'; // ‚Üê –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô!
    let fishData = [
      {
        "name": "–©—É–∫–∞",
        "best_time": "–†–∞–Ω–Ω–µ–µ —É—Ç—Ä–æ –∏ –≤–µ—á–µ—Ä, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ –ø–∞—Å–º—É—Ä–Ω—É—é –ø–æ–≥–æ–¥—É",
        "bait": ["–í–æ–±–ª–µ—Ä", "–ë–ª–µ—Å–Ω–∞", "–ñ–∏–≤–µ—Ü"],
        "feeding": "–ù–µ —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–∏–∫–æ—Ä–º–∫–∏ (—Ö–∏—â–Ω–∏–∫)",
        "season": "–õ—É—á—à–µ –≤–µ—Å–Ω–æ–π –∏ –æ—Å–µ–Ω—å—é"
      },
      {
        "name": "–ö–∞—Ä–ø",
        "best_time": "–î–µ–Ω—å, –æ—Å–æ–±–µ–Ω–Ω–æ –≤ —Ç—ë–ø–ª—É—é –ø–æ–≥–æ–¥—É",
        "bait": ["–ö—É–∫—É—Ä—É–∑–∞", "–ü–µ–ª–ª–µ—Ç—Å", "–ú–∞–∫—É—à–∫–∞"],
        "feeding": "–ü—Ä–∏–∫–æ—Ä–º–∫–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∂–º—ã—Ö–∞, –ø–∞–Ω–∏—Ä–æ–≤–æ—á–Ω—ã—Ö —Å—É—Ö–∞—Ä–µ–π, –∫—É–∫—É—Ä—É–∑—ã",
        "season": "–ò—é–Ω—å‚Äì—Å–µ–Ω—Ç—è–±—Ä—å"
      },
      {
        "name": "–õ–µ—â",
        "best_time": "–ù–æ—á—å –∏ —Ä–∞–Ω–Ω–µ–µ —É—Ç—Ä–æ",
        "bait": ["–ß–µ—Ä–≤—å", "–û–ø–∞—Ä—ã—à", "–ü–µ—Ä–ª–æ–≤–∫–∞"],
        "feeding": "–ì—É—Å—Ç–∞—è –ø—Ä–∏–∫–æ—Ä–º–∫–∞ —Å –≥–ª–∏–Ω–æ–π, –ø–∞–Ω–∏—Ä–æ–≤–∫–æ–π, –º–æ–ª–æ—Ç—ã–º–∏ –∑—ë—Ä–Ω–∞–º–∏",
        "season": "–ú–∞–π‚Äì–æ–∫—Ç—è–±—Ä—å"
      },
      {
        "name": "–û–∫—É–Ω—å",
        "best_time": "–£—Ç—Ä–æ –∏ –≤–µ—á–µ—Ä, –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ—Å–ª–µ –¥–æ–∂–¥—è",
        "bait": ["–ú–∞–ª—å—á–∏–∫", "–ë–ª–µ—Å–Ω–∞", "–°–∏–ª–∏–∫–æ–Ω"],
        "feeding": "–ù–µ –ø—Ä–∏–∫–∞—Ä–º–ª–∏–≤–∞—é—Ç",
        "season": "–ö—Ä—É–≥–ª—ã–π –≥–æ–¥, –∫—Ä–æ–º–µ –≥–ª—É—Ö–æ–∑–∏–º—å—è"
      }
    ];

    let map = null;
    let waterMarkers = [];

    // === –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è ===
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      showSection('fish');
    });

    function initTheme() {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.setAttribute('data-theme', savedTheme);
      document.getElementById('themeToggle').checked = (savedTheme === 'dark');
      
      document.getElementById('themeToggle').addEventListener('change', () => {
        const newTheme = document.getElementById('themeToggle').checked ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
      });
    }

    // === –†–ê–ó–î–ï–õ–´ ===
    function showSection(section) {
      if (section === 'forecast') {
        loadForecast();
        return;
      }
      if (section === 'map') {
        showMap();
        return;
      }

      const content = document.getElementById('content');
      content.innerHTML = '';

      if (section === 'fish') {
        renderFishList();
      } else if (section === 'tips') {
        renderTips();
      }
    }

    // === –†–´–ë–´ ===
    function renderFishList() {
      const content = document.getElementById('content');
      content.innerHTML = '<h2>–†—ã–±—ã –†–æ—Å—Å–∏–∏</h2>';
      fishData.forEach(fish => {
        const div = document.createElement('div');
        div.className = 'fish-card';
        div.innerHTML = `
          <h3>${fish.name}</h3>
          <p><strong>–õ—É—á—à–µ–µ –≤—Ä–µ–º—è:</strong> ${fish.best_time}</p>
          <p><strong>–ù–∞ —á—Ç–æ –ª–æ–≤–∏—Ç—å:</strong> ${fish.bait.join(', ')}</p>
          <p><strong>–ü—Ä–∏–∫–æ—Ä–º–∫–∞:</strong> ${fish.feeding}</p>
          <p><strong>–°–µ–∑–æ–Ω:</strong> ${fish.season}</p>
        `;
        content.appendChild(div);
      });
    }

    // === –°–û–í–ï–¢–´ ===
    function renderTips() {
      const tips = [
        "üìå –£–∑–µ–ª ¬´–ö–ª–∏–Ω—á¬ª ‚Äî –∏–¥–µ–∞–ª–µ–Ω –¥–ª—è –∫—Ä–µ–ø–ª–µ–Ω–∏—è –∫—Ä—é—á–∫–∞.",
        "üìå –õ–æ–≤–∏—Ç–µ –≤ —Ç–µ–Ω–∏ –¥–µ—Ä–µ–≤—å–µ–≤ –ª–µ—Ç–æ–º ‚Äî —Ä—ã–±–∞ –ø—Ä—è—á–µ—Ç—Å—è –æ—Ç –∂–∞—Ä—ã.",
        "üìå –ò–∑–±–µ–≥–∞–π—Ç–µ —Ä–µ–∑–∫–∏—Ö –¥–≤–∏–∂–µ–Ω–∏–π ‚Äî —Ä—ã–±–∞ —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞ –∫ —à—É–º—É.",
        "üìå –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥—Ä—É–∑–∏–ª–æ –ø–æ —Ç–µ—á–µ–Ω–∏—é ‚Äî –æ–Ω–æ –Ω–µ –¥–æ–ª–∂–Ω–æ –ø–æ–¥–Ω–∏–º–∞—Ç—å –º—É—Ç—å.",
        "üìå –ù–æ—á—å—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–∞ —Å–≤–µ—Ç–æ–≤–∞—è –ø—Ä–∏–º–∞–Ω–∫–∞ –¥–ª—è —Ö–∏—â–Ω–∏–∫–æ–≤.",
        "üìå –ê—Ç–º–æ—Å—Ñ–µ—Ä–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ ‚Äî –∫–ª—é—á–µ–≤–æ–π —Ñ–∞–∫—Ç–æ—Ä: —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ = –∞–∫—Ç–∏–≤–Ω—ã–π –∫–ª—ë–≤."
      ];

      const content = document.getElementById('content');
      content.innerHTML = '<h2>–ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</h2>';
      tips.forEach(tip => {
        const div = document.createElement('div');
        div.className = 'tip-card';
        div.textContent = tip;
        content.appendChild(div);
      });
    }

    // === –ü–†–û–ì–ù–û–ó –ö–õ–Å–í–ê ===
    async function loadForecast() {
      const cityInput = document.getElementById('cityInput').value.trim();
      const city = cityInput || 'Moscow';

      try {
        const geoRes = await fetch(
          `https://api.openweathermap.org/geo/1.0/direct?q=${city}&limit=1&appid=${API_KEY}`
        );
        const geoData = await geoRes.json();
        
        if (!geoData || geoData.length === 0) {
          alert('–ì–æ—Ä–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π.');
          return;
        }

        const { lat, lon } = geoData[0];
        const weatherRes = await fetch(
          `https://api.openweathermap.org/data/3.0/onecall?lat=${lat}&lon=${lon}&exclude=current,minutely,hourly,alerts&units=metric&appid=${API_KEY}`
        );
        const weatherData = await weatherRes.json();

        if (weatherData.daily) {
          renderForecast(weatherData.daily.slice(0, 14));
        } else {
          throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ');
        }
      } catch (err) {
        console.error('–û—à–∏–±–∫–∞ API:', err);
        document.getElementById('content').innerHTML = '<p>‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–≥–Ω–æ–∑. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ API-–∫–ª—é—á –∏ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</p>';
      }
    }

    function calculateBiteScore(day) {
      let score = 5;
      const temp = day.temp.day;
      if (temp >= 10 && temp <= 22) score += 2;
      else if (temp < 5 || temp > 28) score -= 2;
      if (day.pressure >= 1000 && day.pressure <= 1025) score += 1;
      if (day.rain) score -= Math.min(2, day.rain * 0.5);
      if (day.snow) score -= Math.min(2, day.snow * 0.5);
      if (day.clouds < 30 || day.clouds > 70) score -= 0.5;
      return Math.max(1, Math.min(10, Math.round(score)));
    }

    function renderForecast(dailyData) {
      const content = document.getElementById('content');
      content.innerHTML = '<h2>–ü—Ä–æ–≥–Ω–æ–∑ –∫–ª—ë–≤–∞ –Ω–∞ 14 –¥–Ω–µ–π</h2>';

      const now = new Date();
      dailyData.forEach((day, i) => {
        const date = new Date(now);
        date.setDate(now.getDate() + i);
        const dayStr = date.toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' });

        const bite = calculateBiteScore(day);
        const quality = bite > 7 ? '–û—Ç–ª–∏—á–Ω—ã–π' : bite > 5 ? '–•–æ—Ä–æ—à–∏–π' : '–°–ª–∞–±—ã–π';

        const div = document.createElement('div');
        div.className = 'forecast-day';
        div.innerHTML = `
          <strong>${dayStr}</strong><br>
          üå°Ô∏è ${Math.round(day.temp.day)}¬∞C | üíß ${day.humidity}% | ‚òÅÔ∏è ${day.clouds}%<br>
          –ö–ª—ë–≤: <strong>${quality}</strong> (${bite}/10)
        `;
        content.appendChild(div);
      });
    }

    // === –ö–ê–†–¢–ê –í–û–î–û–Å–ú–û–í ===
    async function loadWaterBodies(lat = 55.75, lon = 37.62, radiusKm = 50) {
      waterMarkers.forEach(marker => marker.remove());
      waterMarkers = [];
      const radiusMeters = radiusKm * 1000;

      const query = `
        [out:json];
        (
          node["natural"="water"](around:${radiusMeters},${lat},${lon});
          way["natural"="water"](around:${radiusMeters},${lat},${lon});
          relation["natural"="water"](around:${radiusMeters},${lat},${lon});
          node["water"="lake"](around:${radiusMeters},${lat},${lon});
          node["water"="river"](around:${radiusMeters},${lat},${lon});
          node["water"="pond"](around:${radiusMeters},${lat},${lon});
        );
        out center;
      `;

      const overpassUrl = `https://overpass-api.de/api/interpreter?data=${encodeURIComponent(query)}`;

      try {
        const response = await fetch(overpassUrl);
        const data = await response.json();

        data.elements.forEach(el => {
          let name = el.tags?.name || el.tags?.["name:ru"] || "–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è";
          let lat, lon;

          if (el.type === "node") {
            lat = el.lat;
            lon = el.lon;
          } else if ((el.type === "way" || el.type === "relation") && el.center) {
            lat = el.center.lat;
            lon = el.center.lon;
          } else return;

          const marker = L.marker([lat, lon]).addTo(map)
            .bindPopup(`<b>${name}</b><br><small>–í–æ–¥–æ—ë–º</small>`);
          waterMarkers.push(marker);
        });

        if (waterMarkers.length === 0) {
          alert("–í —ç—Ç–æ–º —Ä–∞–π–æ–Ω–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤–æ–¥–æ—ë–º–æ–≤ –≤ –±–∞–∑–µ OpenStreetMap.");
        }
      } catch (err) {
        console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–¥–æ—ë–º–æ–≤:", err);
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–∞—Ä—Ç—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
      }
    }

    function showMap() {
      const content = document.getElementById('content');
      content.innerHTML = '<div id="map"></div>';

      if (!map) {
        map = L.map('map').setView([55.75, 37.62], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        map.on('click', function(e) {
          const { lat, lng } = e.latlng;
          loadWaterBodies(lat, lng, 30);
        });
      }

      loadWaterBodies(55.75, 37.62, 30);
    }
  </script>
</body>
</html>